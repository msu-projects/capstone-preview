<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Interactive Map - South Cotabato Data Bank</title>
  <link rel="stylesheet" href="../assets/css/variables.css">
  <link rel="stylesheet" href="../assets/css/base.css">
  <link rel="stylesheet" href="../assets/css/components.css">
  <link rel="stylesheet" href="../assets/css/utilities.css">
  <link rel="stylesheet" href="../assets/css/public.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
  <header class="public-header">
    <div class="public-header-content">
      <a href="index.html" class="public-logo"><i data-lucide="database"></i><span>SC Data Bank</span></a>
      <nav class="public-nav">
        <a href="index.html" class="public-nav-link"><i data-lucide="home"></i><span>Home</span></a>
        <a href="map.html" class="public-nav-link active"><i data-lucide="map"></i><span>Map View</span></a>
        <a href="projects.html" class="public-nav-link"><i data-lucide="folder"></i><span>Projects</span></a>
        <a href="analytics.html" class="public-nav-link"><i data-lucide="bar-chart"></i><span>Analytics</span></a>
      </nav>
    </div>
  </header>

  <div class="map-container">
    <div class="map-sidebar">
      <div class="map-sidebar-header">
        <h2 style="font-size: var(--text-xl); font-weight: var(--font-semibold);">Sitios</h2>
        <div class="search-bar" style="margin-top: 1rem;">
          <i data-lucide="search" class="search-icon"></i>
          <input type="text" id="searchSitio" class="search-input form-input" placeholder="Search sitios..." onkeyup="filterSitioList()">
        </div>
      </div>
      <div class="map-sidebar-content" id="sitioList"></div>
    </div>

    <div class="map-view">
      <div id="map"></div>
      <div class="map-controls">
        <div class="card" style="padding: 0.75rem;">
          <div style="font-size: var(--text-xs); font-weight: var(--font-semibold); margin-bottom: 0.5rem;">Legend</div>
          <div style="display: flex; flex-direction: column; gap: 0.5rem; font-size: var(--text-xs);">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <div style="width: 1rem; height: 1rem; border-radius: 50%; background: #3B82F6;"></div>
              <span>Sitio Location</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="../assets/js/icons.js"></script>
  <script src="../assets/js/main.js"></script>
  <script src="../assets/js/mock-data.js"></script>
  <script>
    let map, markers = [];
    let selectedSitio = null;

    document.addEventListener('DOMContentLoaded', function() {
      initMap();
      loadSitioList();
    });

    function initMap() {
      // Initialize map centered on South Cotabato
      map = L.map('map').setView([6.35, 124.95], 10);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);

      // Add markers for each sitio
      window.mockData.sitios.forEach(sitio => {
        const marker = L.marker([sitio.coordinates.lat, sitio.coordinates.lng])
          .addTo(map)
          .bindPopup(`
            <div style="min-width: 200px;">
              <h3 style="font-size: var(--text-base); font-weight: var(--font-semibold); margin-bottom: 0.5rem;">${sitio.name}</h3>
              <p style="font-size: var(--text-sm); color: hsl(var(--muted-foreground)); margin-bottom: 0.5rem;">
                ${sitio.barangay}, ${sitio.municipality}
              </p>
              <div style="font-size: var(--text-sm); margin-bottom: 0.5rem;">
                <div><strong>Population:</strong> ${formatNumber(sitio.population)}</div>
                <div><strong>Households:</strong> ${formatNumber(sitio.households)}</div>
                <div><strong>Projects:</strong> ${sitio.projects_count}</div>
              </div>
              <button onclick="viewSitioDetail(${sitio.id})" class="btn btn-primary btn-sm" style="width: 100%;">
                View Details
              </button>
            </div>
          `);

        marker.sitioId = sitio.id;
        markers.push(marker);
      });
    }

    function loadSitioList() {
      const container = document.getElementById('sitioList');
      const sitios = window.mockData.sitios;

      container.innerHTML = sitios.map(sitio => `
        <div class="sitio-list-item" data-sitio-id="${sitio.id}" onclick="selectSitio(${sitio.id})">
          <div class="sitio-list-item-header">
            <div class="sitio-list-item-title">${sitio.name}</div>
            <span class="badge badge-primary">${sitio.projects_count}</span>
          </div>
          <div class="sitio-list-item-meta">
            ${sitio.barangay}, ${sitio.municipality}
          </div>
          <div style="font-size: var(--text-xs); color: hsl(var(--muted-foreground)); margin-top: 0.25rem;">
            Pop: ${formatNumber(sitio.population)} | HH: ${formatNumber(sitio.households)}
          </div>
        </div>
      `).join('');
    }

    function selectSitio(id) {
      selectedSitio = id;

      // Update UI
      document.querySelectorAll('.sitio-list-item').forEach(item => {
        item.classList.toggle('active', parseInt(item.dataset.sitioId) === id);
      });

      // Find and open marker popup
      const sitio = window.mockData.getSitioById(id);
      if (sitio) {
        map.setView([sitio.coordinates.lat, sitio.coordinates.lng], 14);
        const marker = markers.find(m => m.sitioId === id);
        if (marker) marker.openPopup();
      }
    }

    function filterSitioList() {
      const search = document.getElementById('searchSitio').value.toLowerCase();
      document.querySelectorAll('.sitio-list-item').forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(search) ? 'block' : 'none';
      });
    }

    function viewSitioDetail(id) {
      window.location.href = `sitio-detail.html?id=${id}`;
    }
  </script>
</body>
</html>
