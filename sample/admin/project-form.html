<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Project Form - South Cotabato Data Bank</title>
    <link rel="stylesheet" href="../assets/css/variables.css" />
    <link rel="stylesheet" href="../assets/css/base.css" />
    <link rel="stylesheet" href="../assets/css/components.css" />
    <link rel="stylesheet" href="../assets/css/utilities.css" />
    <link rel="stylesheet" href="../assets/css/admin.css" />
  </head>
  <body>
    <div class="admin-layout">
      <aside class="admin-sidebar">
        <div class="admin-sidebar-header">
          <a href="index.html" class="admin-logo"
            ><i data-lucide="database"></i><span>SC Data Bank</span></a
          >
        </div>
        <nav class="admin-nav">
          <div class="admin-nav-section">
            <div class="admin-nav-title">Main</div>
            <a href="index.html" class="admin-nav-link"
              ><i data-lucide="layout-dashboard"></i><span>Dashboard</span></a
            >
          </div>
          <div class="admin-nav-section">
            <div class="admin-nav-title">Data Management</div>
            <a href="sitio-list.html" class="admin-nav-link"
              ><i data-lucide="map-pin"></i><span>Sitios</span></a
            >
            <a href="project-list.html" class="admin-nav-link active"
              ><i data-lucide="folder"></i><span>Projects</span></a
            >
            <a href="import.html" class="admin-nav-link"
              ><i data-lucide="upload-cloud"></i><span>Import Data</span></a
            >
          </div>
        </nav>
        <div class="admin-sidebar-footer">
          <div class="admin-user-info">
            <div class="admin-user-avatar">A</div>
            <div class="admin-user-details">
              <div class="admin-user-name">Admin User</div>
            </div>
          </div>
        </div>
      </aside>
      <main class="admin-main">
        <header class="admin-header">
          <div class="admin-header-content">
            <div>
              <div class="breadcrumb">
                <a href="project-list.html" class="breadcrumb-link">Projects</a>
                <span class="breadcrumb-separator">/</span>
                <span class="breadcrumb-current" id="pageTitle"
                  >Add New Project</span
                >
              </div>
              <h1 class="admin-page-title" id="formTitle">Add New Project</h1>
              <p class="breadcrumb-helper">
                Capture key implementation metrics in one pass. Details flow
                directly into the tracker and public portal.
              </p>
            </div>
          </div>
        </header>
        <div class="admin-content">
          <div
            class="form-notification"
            id="formNotification"
            style="display: none"
          >
            <div class="notification-content">
              <i data-lucide="info" class="notification-icon"></i>
              <span class="notification-message"></span>
            </div>
            <button
              type="button"
              class="notification-close"
              onclick="closeNotification()"
            >
              <i data-lucide="x"></i>
            </button>
          </div>
          <form id="projectForm">
            <div class="project-form-layout">
              <div class="project-form-main">
                <section class="form-section" data-section="overview">
                  <div
                    class="form-section-header"
                    onclick="toggleSection('overview')"
                  >
                    <div class="form-section-title-row">
                      <h3 class="form-section-title">
                        <i
                          data-lucide="chevron-down"
                          class="section-toggle-icon"
                        ></i>
                        Project Overview
                        <span class="required-badge">Required</span>
                      </h3>
                      <span class="section-status" id="status-overview"></span>
                    </div>
                    <p class="form-section-description">
                      Give a clear summary so stakeholders immediately
                      understand the intervention.
                    </p>
                  </div>
                  <div class="form-grid">
                    <div class="form-grid-full">
                      <label for="title" class="form-label form-label-required"
                        >Project Title</label
                      >
                      <input
                        type="text"
                        id="title"
                        class="form-input"
                        required
                        data-summary-field
                        placeholder="Enter a descriptive project title"
                      />
                      <span
                        class="field-validation"
                        id="title-validation"
                      ></span>
                    </div>
                    <div class="form-grid-full">
                      <label
                        for="description"
                        class="form-label form-label-required"
                        >Description</label
                      >
                      <textarea
                        id="description"
                        class="form-textarea"
                        rows="4"
                        required
                      ></textarea>
                    </div>
                    <div>
                      <label
                        for="category"
                        class="form-label form-label-required"
                        >Category</label
                      >
                      <select
                        id="category"
                        class="form-select"
                        required
                        data-summary-field
                      >
                        <option value="">Select Category</option>
                        <option value="Water and Sanitation">
                          Water and Sanitation
                        </option>
                        <option value="Infrastructure">Infrastructure</option>
                        <option value="Energy Access">Energy Access</option>
                        <option value="Education">Education</option>
                        <option value="Livelihood">Livelihood</option>
                        <option value="Health">Health</option>
                        <option value="Housing">Housing</option>
                      </select>
                    </div>
                    <div>
                      <label for="project_year" class="form-label"
                        >Project Year</label
                      >
                      <input
                        type="number"
                        id="project_year"
                        class="form-input"
                        min="2020"
                        max="2035"
                        value="2025"
                        data-summary-field
                      />
                    </div>
                    <div>
                      <label for="sitio" class="form-label form-label-required"
                        >Sitio</label
                      >
                      <select
                        id="sitio"
                        class="form-select"
                        required
                        data-summary-field
                      ></select>
                    </div>
                    <div>
                      <label for="municipality" class="form-label"
                        >Municipality</label
                      >
                      <input
                        type="text"
                        id="municipality"
                        class="form-input"
                        readonly
                        data-summary-field
                      />
                      <p class="form-helper">
                        Auto-filled from the selected sitio.
                      </p>
                    </div>
                  </div>
                </section>

                <section class="form-section" data-section="implementation">
                  <div
                    class="form-section-header"
                    onclick="toggleSection('implementation')"
                  >
                    <div class="form-section-title-row">
                      <h3 class="form-section-title">
                        <i
                          data-lucide="chevron-down"
                          class="section-toggle-icon"
                        ></i>
                        Implementation Details
                        <span class="required-badge">Required</span>
                      </h3>
                      <span
                        class="section-status"
                        id="status-implementation"
                      ></span>
                    </div>
                    <p class="form-section-description">
                      Status, schedule, and agencies determine visibility across
                      dashboards.
                    </p>
                  </div>
                  <div class="form-grid">
                    <div>
                      <label for="status" class="form-label form-label-required"
                        >Status</label
                      >
                      <select
                        id="status"
                        class="form-select"
                        required
                        data-summary-field
                      >
                        <option value="planning">Planning</option>
                        <option value="in_progress">In Progress</option>
                        <option value="completed">Completed</option>
                        <option value="suspended">Suspended</option>
                      </select>
                    </div>
                    <div>
                      <label for="completion_percentage" class="form-label"
                        >Completion (%)</label
                      >
                      <input
                        type="number"
                        id="completion_percentage"
                        class="form-input"
                        min="0"
                        max="100"
                        value="0"
                        readonly
                        data-summary-field
                      />
                      <p class="form-helper">
                        Auto-calculated from Physical Actual (%).
                      </p>
                    </div>
                    <div>
                      <label
                        for="start_date"
                        class="form-label form-label-required"
                        >Start Date</label
                      >
                      <input
                        type="date"
                        id="start_date"
                        class="form-input"
                        required
                        data-summary-field
                      />
                    </div>
                    <div>
                      <label for="end_date" class="form-label">End Date</label>
                      <input
                        type="date"
                        id="end_date"
                        class="form-input"
                        data-summary-field
                      />
                    </div>
                    <div>
                      <label for="implementing_agency" class="form-label"
                        >Implementing Agency</label
                      >
                      <input
                        type="text"
                        id="implementing_agency"
                        class="form-input"
                        data-summary-field
                      />
                    </div>
                    <div>
                      <label for="beneficiaries" class="form-label"
                        >Beneficiaries</label
                      >
                      <input
                        type="number"
                        id="beneficiaries"
                        class="form-input"
                      />
                    </div>
                  </div>
                </section>

                <section class="form-section" data-section="financial">
                  <div
                    class="form-section-header"
                    onclick="toggleSection('financial')"
                  >
                    <div class="form-section-title-row">
                      <h3 class="form-section-title">
                        <i
                          data-lucide="chevron-down"
                          class="section-toggle-icon"
                        ></i>
                        Financial Setup
                        <span class="required-badge">Required</span>
                      </h3>
                      <span class="section-status" id="status-financial"></span>
                    </div>
                    <p class="form-section-description">
                      Align with quarterly financial monitoring requirements.
                    </p>
                  </div>
                  <div class="form-grid">
                    <div>
                      <label for="budget" class="form-label form-label-required"
                        >Base Budget (â‚±)</label
                      >
                      <input
                        type="text"
                        id="budget"
                        class="form-input currency-input"
                        required
                        data-summary-field
                        placeholder="0.00"
                        data-type="currency"
                      />
                      <span
                        class="field-validation"
                        id="budget-validation"
                      ></span>
                    </div>
                    <div>
                      <label for="fund_source" class="form-label"
                        >Fund Source</label
                      >
                      <input
                        type="text"
                        id="fund_source"
                        class="form-input"
                        value="20% LDF"
                      />
                    </div>
                    <div>
                      <label for="implementing_unit" class="form-label"
                        >Implementing Unit</label
                      >
                      <input
                        type="text"
                        id="implementing_unit"
                        class="form-input"
                        placeholder="e.g., Provincial Engineer's Office"
                      />
                    </div>
                    <div>
                      <label for="allotment_allocated" class="form-label"
                        >Allocated Budget</label
                      >
                      <input
                        type="text"
                        id="allotment_allocated"
                        class="form-input currency-input"
                        data-summary-field
                        placeholder="0.00"
                        data-type="currency"
                      />
                    </div>
                    <div>
                      <label for="allotment_supplemental" class="form-label"
                        >Supplemental Budget</label
                      >
                      <input
                        type="text"
                        id="allotment_supplemental"
                        class="form-input currency-input"
                        placeholder="0.00"
                        data-type="currency"
                      />
                    </div>
                    <div>
                      <label for="allotment_released" class="form-label"
                        >Allotment Released</label
                      >
                      <input
                        type="text"
                        id="allotment_released"
                        class="form-input currency-input"
                        data-summary-field
                        placeholder="0.00"
                        data-type="currency"
                      />
                    </div>
                    <div>
                      <label for="expenditure_obligations" class="form-label"
                        >Obligations Incurred</label
                      >
                      <input
                        type="text"
                        id="expenditure_obligations"
                        class="form-input currency-input"
                        data-summary-field
                        placeholder="0.00"
                        data-type="currency"
                      />
                    </div>
                    <div>
                      <label for="contract_cost" class="form-label"
                        >Contract Cost</label
                      >
                      <input
                        type="text"
                        id="contract_cost"
                        class="form-input currency-input"
                        placeholder="0.00"
                        data-type="currency"
                      />
                    </div>
                  </div>
                </section>

                <section class="form-section" data-section="metrics">
                  <div
                    class="form-section-header"
                    onclick="toggleSection('metrics')"
                  >
                    <div class="form-section-title-row">
                      <h3 class="form-section-title">
                        <i
                          data-lucide="chevron-down"
                          class="section-toggle-icon"
                        ></i>
                        Physical & Employment Metrics
                      </h3>
                      <span class="section-status" id="status-metrics"></span>
                    </div>
                    <p class="form-section-description">
                      Show planned vs actual delivery and employment generated.
                    </p>
                  </div>
                  <div class="form-grid">
                    <div>
                      <label for="physical_plan" class="form-label"
                        >Plan (%)</label
                      >
                      <input
                        type="number"
                        id="physical_plan"
                        class="form-input"
                        min="0"
                        max="100"
                      />
                    </div>
                    <div>
                      <label for="physical_actual" class="form-label"
                        >Actual (%)</label
                      >
                      <input
                        type="number"
                        id="physical_actual"
                        class="form-input"
                        min="0"
                        max="100"
                      />
                    </div>
                    <div>
                      <label for="physical_slippage" class="form-label"
                        >Slippage (%)</label
                      >
                      <input
                        type="number"
                        id="physical_slippage"
                        class="form-input"
                        readonly
                      />
                    </div>
                    <div>
                      <label for="employment_male" class="form-label"
                        >Employment (Male)</label
                      >
                      <input
                        type="number"
                        id="employment_male"
                        class="form-input"
                      />
                    </div>
                    <div>
                      <label for="employment_female" class="form-label"
                        >Employment (Female)</label
                      >
                      <input
                        type="number"
                        id="employment_female"
                        class="form-input"
                      />
                    </div>
                  </div>
                </section>

                <section class="form-section" data-section="accountability">
                  <div
                    class="form-section-header"
                    onclick="toggleSection('accountability')"
                  >
                    <div class="form-section-title-row">
                      <h3 class="form-section-title">
                        <i
                          data-lucide="chevron-down"
                          class="section-toggle-icon"
                        ></i>
                        Project Accountability
                      </h3>
                      <span
                        class="section-status"
                        id="status-accountability"
                      ></span>
                    </div>
                    <p class="form-section-description">
                      Assign key personnel and establish accountability
                      structure.
                    </p>
                  </div>
                  <div class="form-grid">
                    <div>
                      <label for="project_manager" class="form-label"
                        >Project Manager</label
                      >
                      <input
                        type="text"
                        id="project_manager"
                        class="form-input"
                        placeholder="Engr. Juan Dela Cruz"
                      />
                    </div>
                    <div>
                      <label for="pm_agency" class="form-label"
                        >PM Agency</label
                      >
                      <input
                        type="text"
                        id="pm_agency"
                        class="form-input"
                        value="Provincial Engineer's Office"
                      />
                    </div>
                    <div>
                      <label for="technical_lead" class="form-label"
                        >Technical Lead</label
                      >
                      <input
                        type="text"
                        id="technical_lead"
                        class="form-input"
                        placeholder="Engr. Maria Santos"
                      />
                    </div>
                    <div>
                      <label for="contractor" class="form-label"
                        >Contractor</label
                      >
                      <input
                        type="text"
                        id="contractor"
                        class="form-input"
                        placeholder="ABC Construction Corp"
                      />
                    </div>
                  </div>
                </section>

                <section class="form-section" data-section="contract">
                  <div
                    class="form-section-header"
                    onclick="toggleSection('contract')"
                  >
                    <div class="form-section-title-row">
                      <h3 class="form-section-title">
                        <i
                          data-lucide="chevron-down"
                          class="section-toggle-icon"
                        ></i>
                        Contract & Catch-Up Notes
                      </h3>
                      <span class="section-status" id="status-contract"></span>
                    </div>
                    <p class="form-section-description">
                      Document contract details and recovery plans.
                    </p>
                  </div>
                  <div class="form-grid">
                    <div>
                      <label for="contract_duration" class="form-label"
                        >Contract Duration</label
                      >
                      <input
                        type="text"
                        id="contract_duration"
                        class="form-input"
                        placeholder="e.g., 120 CD"
                      />
                    </div>
                    <div>
                      <label for="contract_delivery" class="form-label"
                        >Delivery Time</label
                      >
                      <input
                        type="text"
                        id="contract_delivery"
                        class="form-input"
                        placeholder="e.g., 120 CD"
                      />
                    </div>
                    <div>
                      <label for="contract_extension" class="form-label"
                        >Extension</label
                      >
                      <input
                        type="text"
                        id="contract_extension"
                        class="form-input"
                        placeholder="None"
                      />
                    </div>
                    <div class="form-grid-full">
                      <label for="status_stage" class="form-label"
                        >Current Stage</label
                      >
                      <input
                        type="text"
                        id="status_stage"
                        class="form-input"
                        data-summary-field
                      />
                    </div>
                    <div class="form-grid-full">
                      <label for="status_issues" class="form-label"
                        >Issues / Justification</label
                      >
                      <textarea
                        id="status_issues"
                        class="form-textarea"
                        rows="3"
                        data-summary-field
                      ></textarea>
                    </div>
                    <div class="form-grid-full">
                      <label for="status_recommendations" class="form-label"
                        >Recommendations</label
                      >
                      <textarea
                        id="status_recommendations"
                        class="form-textarea"
                        rows="3"
                      ></textarea>
                    </div>
                    <div class="form-grid-full">
                      <label for="catch_up_plan" class="form-label"
                        >Catch-Up Plan</label
                      >
                      <textarea
                        id="catch_up_plan"
                        class="form-textarea"
                        rows="3"
                        data-summary-field
                      ></textarea>
                    </div>
                  </div>
                </section>

                <section class="form-section" data-section="milestones">
                  <div
                    class="form-section-header"
                    onclick="toggleSection('milestones')"
                  >
                    <div class="form-section-title-row">
                      <h3 class="form-section-title">
                        <i
                          data-lucide="chevron-down"
                          class="section-toggle-icon"
                        ></i>
                        Project Milestones
                      </h3>
                      <span
                        class="section-status"
                        id="status-milestones"
                      ></span>
                    </div>
                    <p class="form-section-description">
                      Track key project milestones across Planning â†’ Design â†’
                      Procurement â†’ Implementation â†’ Completion phases.
                    </p>
                  </div>
                  <div class="milestone-container">
                    <div id="milestonesList" class="milestones-list">
                      <div class="milestones-empty">
                        <i data-lucide="calendar-check"></i>
                        <p>
                          No milestones added yet. Milestones will appear here
                          once you load or create a project with milestone data.
                        </p>
                      </div>
                    </div>
                    <button
                      type="button"
                      class="btn btn-outline"
                      onclick="addMilestone()"
                    >
                      <i data-lucide="plus"></i><span>Add Milestone</span>
                    </button>
                  </div>
                </section>

                <section class="form-section" data-section="delays">
                  <div
                    class="form-section-header"
                    onclick="toggleSection('delays')"
                  >
                    <div class="form-section-title-row">
                      <h3 class="form-section-title">
                        <i
                          data-lucide="chevron-down"
                          class="section-toggle-icon"
                        ></i>
                        Delays & Blockers
                      </h3>
                      <span class="section-status" id="status-delays"></span>
                    </div>
                    <p class="form-section-description">
                      Document delays with root cause, impact assessment, and
                      accountability.
                    </p>
                  </div>
                  <div class="delays-container">
                    <div id="delaysList" class="delays-list">
                      <div class="delays-empty">
                        <i data-lucide="alert-circle"></i>
                        <p>
                          No delays reported. Click "Report Delay" to document
                          project blockers.
                        </p>
                      </div>
                    </div>
                    <button
                      type="button"
                      class="btn btn-outline"
                      onclick="addDelay()"
                    >
                      <i data-lucide="alert-triangle"></i
                      ><span>Report Delay</span>
                    </button>
                  </div>
                </section>

                <section class="form-section" data-section="recovery">
                  <div
                    class="form-section-header"
                    onclick="toggleSection('recovery')"
                  >
                    <div class="form-section-title-row">
                      <h3 class="form-section-title">
                        <i
                          data-lucide="chevron-down"
                          class="section-toggle-icon"
                        ></i>
                        Recovery Actions
                      </h3>
                      <span class="section-status" id="status-recovery"></span>
                    </div>
                    <p class="form-section-description">
                      Define specific actions to mitigate delays and get project
                      back on track.
                    </p>
                  </div>
                  <div class="recovery-container">
                    <div id="recoveryActionsList" class="recovery-list">
                      <div class="recovery-empty">
                        <i data-lucide="trending-up"></i>
                        <p>
                          No recovery actions defined. Add actions to address
                          delays and improve progress.
                        </p>
                      </div>
                    </div>
                    <button
                      type="button"
                      class="btn btn-outline"
                      onclick="addRecoveryAction()"
                    >
                      <i data-lucide="plus-circle"></i
                      ><span>Add Recovery Action</span>
                    </button>
                  </div>
                </section>

                <div class="form-actions">
                  <div class="form-actions-hint">
                    <span class="text-muted text-xs hidden">
                      ðŸ’¡ Tip: Press <kbd>Ctrl+S</kbd> to save,
                      <kbd>Ctrl+K</kbd> to toggle sections
                    </span>
                  </div>
                  <div class="form-actions-buttons">
                    <button
                      type="button"
                      class="btn btn-ghost"
                      onclick="window.location.href='project-list.html'"
                    >
                      Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                      <i data-lucide="save"></i><span>Save Project</span>
                    </button>
                  </div>
                </div>
              </div>

              <aside class="project-form-sidebar">
                <div class="summary-card">
                  <div class="summary-card-header">
                    <span>Project Snapshot</span>
                    <div id="summaryStatus"></div>
                  </div>
                  <div class="summary-progress">
                    <div
                      class="summary-progress-value"
                      id="summaryProgressValue"
                    >
                      0%
                    </div>
                    <div class="summary-progress-bar">
                      <div id="summaryProgressBar"></div>
                    </div>
                  </div>
                  <dl class="summary-list">
                    <div>
                      <dt>Category</dt>
                      <dd id="summaryCategory">â€”</dd>
                    </div>
                    <div>
                      <dt>Budget</dt>
                      <dd id="summaryBudget">â‚±0.00</dd>
                    </div>
                    <div>
                      <dt>Location</dt>
                      <dd id="summaryLocation">â€”</dd>
                    </div>
                    <div>
                      <dt>Timeline</dt>
                      <dd id="summaryTimeline">Unset</dd>
                    </div>
                  </dl>
                </div>

                <div class="summary-card">
                  <div class="summary-card-header">
                    <span>Monitoring Health</span>
                  </div>
                  <dl class="summary-list">
                    <div>
                      <dt>Allotted</dt>
                      <dd id="summaryAllotted">â‚±0.00</dd>
                    </div>
                    <div>
                      <dt>Released</dt>
                      <dd id="summaryReleased">â‚±0.00</dd>
                    </div>
                    <div>
                      <dt>Obligated</dt>
                      <dd id="summaryObligated">â‚±0.00</dd>
                    </div>
                  </dl>
                  <div class="summary-pill" id="summaryUtilization">
                    Utilization: 0%
                  </div>
                  <div class="summary-mini">
                    <div>
                      <div class="summary-mini-label">Stage</div>
                      <div class="summary-mini-value" id="summaryStage">â€”</div>
                    </div>
                    <div>
                      <div class="summary-mini-label">Catch-up Plan</div>
                      <div class="summary-mini-value" id="summaryCatchup">
                        â€”
                      </div>
                    </div>
                  </div>
                  <p class="summary-issues" id="summaryIssues">
                    Highlight emerging issues here.
                  </p>
                </div>
              </aside>
            </div>
          </form>
        </div>
      </main>
    </div>

    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="../assets/js/icons.js"></script>
    <script src="../assets/js/main.js"></script>
    <script src="../assets/js/mock-data.js"></script>
    <script>
      if (!localStorage.getItem("isLoggedIn"))
        window.location.href = "login.html";

      const urlParams = new URLSearchParams(window.location.search);
      const projectId = urlParams.get("id");
      const sitioIndex = {};
      let autoSaveTimeout;
      const AUTO_SAVE_DELAY = 2000; // 2 seconds

      // ===== COLLAPSIBLE SECTIONS =====
      function toggleSection(sectionName) {
        const section = document.querySelector(
          `[data-section="${sectionName}"]`
        );
        if (section) {
          section.classList.toggle("collapsed");
          lucide.createIcons(); // Refresh icons
        }
      }

      // ===== FORM NOTIFICATION =====
      function showNotification(message, type = "info") {
        const notification = document.getElementById("formNotification");
        const messageEl = notification.querySelector(".notification-message");
        const iconEl = notification.querySelector(".notification-icon");

        notification.className = `form-notification ${type}`;
        messageEl.textContent = message;
        notification.style.display = "flex";

        // Update icon based on type
        iconEl.setAttribute(
          "data-lucide",
          type === "success"
            ? "check-circle"
            : type === "error"
            ? "alert-circle"
            : type === "warning"
            ? "alert-triangle"
            : "info"
        );
        lucide.createIcons();
      }

      function closeNotification() {
        document.getElementById("formNotification").style.display = "none";
      }

      // ===== CURRENCY FORMATTING =====
      function formatCurrencyInput(input) {
        let value = input.value.replace(/[^\d.]/g, "");
        const parts = value.split(".");
        if (parts.length > 2) {
          value = parts[0] + "." + parts.slice(1).join("");
        }
        if (parts[1] && parts[1].length > 2) {
          value = parts[0] + "." + parts[1].substring(0, 2);
        }

        if (value) {
          const num = parseFloat(value);
          if (!isNaN(num)) {
            input.value = num.toLocaleString("en-US", {
              minimumFractionDigits: 0,
              maximumFractionDigits: 2,
            });
          }
        }
      }

      function getCurrencyValue(input) {
        return parseFloat(input.value.replace(/,/g, "")) || 0;
      }

      // ===== FIELD VALIDATION =====
      function validateField(field) {
        const validationEl = document.getElementById(`${field.id}-validation`);
        if (!validationEl) return true;

        let isValid = true;
        let message = "";

        // Required field validation
        if (field.hasAttribute("required") && !field.value.trim()) {
          isValid = false;
          message = "This field is required";
        }
        // Currency validation
        else if (field.classList.contains("currency-input")) {
          const value = getCurrencyValue(field);
          if (field.hasAttribute("required") && value <= 0) {
            isValid = false;
            message = "Please enter a valid amount";
          } else if (value > 0) {
            message = "âœ“ Valid";
            field.classList.add("has-success");
            field.classList.remove("has-error");
            validationEl.className = "field-validation success";
          }
        }
        // Text length validation
        else if (
          field.value.trim().length > 0 &&
          field.value.trim().length < 3
        ) {
          isValid = false;
          message = "Must be at least 3 characters";
        } else if (field.value.trim().length > 0) {
          message = "âœ“ Valid";
          field.classList.add("has-success");
          field.classList.remove("has-error");
          validationEl.className = "field-validation success";
        }

        if (!isValid) {
          field.classList.add("has-error");
          field.classList.remove("has-success");
          validationEl.className = "field-validation error";
        }

        validationEl.textContent = message;
        updateSectionStatus();
        return isValid;
      }

      // ===== SECTION STATUS =====
      function updateSectionStatus() {
        const sections = ["overview", "implementation", "financial"];

        sections.forEach((sectionName) => {
          const section = document.querySelector(
            `[data-section="${sectionName}"]`
          );
          const statusEl = document.getElementById(`status-${sectionName}`);
          if (!section || !statusEl) return;

          const requiredFields = section.querySelectorAll("[required]");
          const filledFields = Array.from(requiredFields).filter((f) =>
            f.value.trim()
          );
          const total = requiredFields.length;
          const filled = filledFields.length;

          if (filled === total && total > 0) {
            statusEl.textContent = "âœ“ Complete";
            statusEl.className = "section-status complete";
          } else if (filled > 0) {
            statusEl.textContent = `${filled}/${total} fields`;
            statusEl.className = "section-status incomplete";
          } else {
            statusEl.textContent = `0/${total} fields`;
            statusEl.className = "section-status incomplete";
          }
        });
      }

      // ===== AUTO-SAVE =====
      function autoSaveForm() {
        if (autoSaveTimeout) clearTimeout(autoSaveTimeout);

        autoSaveTimeout = setTimeout(() => {
          const formData = new FormData(document.getElementById("projectForm"));
          const data = Object.fromEntries(formData.entries());

          // Save to localStorage
          const draftKey = projectId
            ? `project-draft-${projectId}`
            : "project-draft-new";
          localStorage.setItem(
            draftKey,
            JSON.stringify({
              data,
              timestamp: new Date().toISOString(),
            })
          );

          showNotification("Draft saved automatically", "success");
          setTimeout(closeNotification, 2000);
        }, AUTO_SAVE_DELAY);
      }

      // ===== LOAD DRAFT =====
      function loadDraft() {
        const draftKey = projectId
          ? `project-draft-${projectId}`
          : "project-draft-new";
        const draft = localStorage.getItem(draftKey);

        if (draft && !projectId) {
          try {
            const { data, timestamp } = JSON.parse(draft);
            const date = new Date(timestamp);
            const confirmLoad = confirm(
              `Found a draft from ${date.toLocaleDateString()} ${date.toLocaleTimeString()}. Load it?`
            );

            if (confirmLoad) {
              Object.entries(data).forEach(([key, value]) => {
                const field = document.getElementById(key);
                if (field) field.value = value;
              });
              showNotification("Draft loaded successfully", "success");
              updateProjectSummary();
              updateSectionStatus();
            }
          } catch (e) {
            console.error("Error loading draft:", e);
          }
        }
      }

      // ===== MILESTONE MANAGEMENT =====
      let projectMilestones = [];
      let projectDelays = [];
      let projectRecoveryActions = [];
      let projectPhases = [];

      function renderMilestones() {
        const container = document.getElementById("milestonesList");
        if (!projectMilestones || projectMilestones.length === 0) {
          container.innerHTML = `
            <div class="milestones-empty">
              <i data-lucide="calendar-check"></i>
              <p>No milestones added yet. Milestones will appear here once you load or create a project with milestone data.</p>
            </div>
          `;
          lucide.createIcons();
          return;
        }

        const getPhaseName = (phaseId) => {
          const phase = projectPhases.find((p) => p.id === phaseId);
          return phase ? phase.name : "Unknown Phase";
        };

        const getStatusBadge = (status) => {
          const badges = {
            completed: "success",
            in_progress: "warning",
            delayed: "destructive",
            at_risk: "warning",
            not_started: "secondary",
          };
          return badges[status] || "secondary";
        };

        const html = projectMilestones
          .map(
            (milestone) => `
          <div class="milestone-card" data-milestone-id="${milestone.id}">
            <div class="milestone-header">
              <div class="milestone-title-row">
                <h4 class="milestone-name">${milestone.name}</h4>
                <span class="badge ${getStatusBadge(
                  milestone.status
                )}">${milestone.status.replace("_", " ")}</span>
              </div>
              <div class="milestone-meta">
                <span class="milestone-phase">${getPhaseName(
                  milestone.phase_id
                )}</span>
                <span class="milestone-owner">Owner: ${milestone.owner}</span>
              </div>
            </div>
            <div class="milestone-body">
              <p class="milestone-description">${milestone.description}</p>
              <div class="milestone-progress">
                <div class="progress-bar-wrapper">
                  <div class="progress-bar" style="width: ${
                    milestone.completion_percentage
                  }%"></div>
                </div>
                <span class="progress-text">${
                  milestone.completion_percentage
                }%</span>
              </div>
              <div class="milestone-dates">
                <div class="date-group">
                  <label>Planned:</label>
                  <span>${formatDate(milestone.planned_start)} - ${formatDate(
              milestone.planned_end
            )}</span>
                </div>
                ${
                  milestone.actual_start
                    ? `
                  <div class="date-group">
                    <label>Actual:</label>
                    <span>${formatDate(milestone.actual_start)} - ${
                        milestone.actual_end
                          ? formatDate(milestone.actual_end)
                          : "Ongoing"
                      }</span>
                  </div>
                `
                    : ""
                }
              </div>
              ${
                milestone.delay_ids && milestone.delay_ids.length > 0
                  ? `
                <div class="milestone-delays">
                  <i data-lucide="alert-triangle"></i>
                  <span>${milestone.delay_ids.length} active delay(s)</span>
                </div>
              `
                  : ""
              }
            </div>
          </div>
        `
          )
          .join("");

        container.innerHTML = html;
        lucide.createIcons();
      }

      function renderDelays() {
        const container = document.getElementById("delaysList");
        if (!projectDelays || projectDelays.length === 0) {
          container.innerHTML = `
            <div class="delays-empty">
              <i data-lucide="alert-circle"></i>
              <p>No delays reported. Click "Report Delay" to document project blockers.</p>
            </div>
          `;
          lucide.createIcons();
          return;
        }

        const getSeverityBadge = (severity) => {
          const badges = {
            critical: "destructive",
            high: "warning",
            medium: "warning",
            low: "secondary",
          };
          return badges[severity] || "secondary";
        };

        const html = projectDelays
          .map(
            (delay) => `
          <div class="delay-card severity-${delay.severity}" data-delay-id="${
              delay.id
            }">
            <div class="delay-header">
              <div class="delay-title-row">
                <h4 class="delay-title">${delay.title}</h4>
                <span class="badge ${getSeverityBadge(delay.severity)}">${
              delay.severity
            } severity</span>
              </div>
              <div class="delay-meta">
                <span>${delay.delay_type.replace("_", " ")}</span>
                <span>Reported: ${formatDate(delay.reported_date)}</span>
              </div>
            </div>
            <div class="delay-body">
              <div class="delay-field">
                <label>Root Cause:</label>
                <p>${delay.root_cause}</p>
              </div>
              <div class="delay-field">
                <label>Responsible Party:</label>
                <p>${
                  delay.responsible_party
                } (${delay.accountability_type.replace("_", " ")})</p>
              </div>
              <div class="delay-impact">
                <div class="impact-item">
                  <i data-lucide="calendar"></i>
                  <span>${delay.schedule_impact_days} days</span>
                </div>
                ${
                  delay.cost_impact > 0
                    ? `
                  <div class="impact-item">
                    <i data-lucide="dollar-sign"></i>
                    <span>${formatCurrency(delay.cost_impact)}</span>
                  </div>
                `
                    : ""
                }
                <div class="impact-item">
                  <i data-lucide="users"></i>
                  <span>${delay.beneficiary_impact}</span>
                </div>
              </div>
              <div class="delay-status-row">
                <span class="status-badge ${delay.status}">${
              delay.status
            }</span>
                <span class="target-date">Target: ${formatDate(
                  delay.resolution_target_date
                )}</span>
              </div>
            </div>
          </div>
        `
          )
          .join("");

        container.innerHTML = html;
        lucide.createIcons();
      }

      function renderRecoveryActions() {
        const container = document.getElementById("recoveryActionsList");
        if (!projectRecoveryActions || projectRecoveryActions.length === 0) {
          container.innerHTML = `
            <div class="recovery-empty">
              <i data-lucide="trending-up"></i>
              <p>No recovery actions defined. Add actions to address delays and improve progress.</p>
            </div>
          `;
          lucide.createIcons();
          return;
        }

        const getStatusBadge = (status) => {
          const badges = {
            completed: "success",
            in_progress: "warning",
            planned: "secondary",
            ineffective: "destructive",
          };
          return badges[status] || "secondary";
        };

        const html = projectRecoveryActions
          .map(
            (action) => `
          <div class="recovery-card" data-action-id="${action.id}">
            <div class="recovery-header">
              <div class="recovery-title-row">
                <h4 class="recovery-action">${action.action}</h4>
                <span class="badge ${getStatusBadge(
                  action.status
                )}">${action.status.replace("_", " ")}</span>
              </div>
              <div class="recovery-meta">
                <span>Owner: ${action.owner}</span>
                <span>Target: ${formatDate(action.target_completion)}</span>
              </div>
            </div>
            <div class="recovery-body">
              <p class="recovery-description">${action.description}</p>
              <div class="recovery-progress">
                <div class="progress-bar-wrapper">
                  <div class="progress-bar" style="width: ${
                    action.progress_percentage
                  }%"></div>
                </div>
                <span class="progress-text">${
                  action.progress_percentage
                }%</span>
              </div>
              ${
                action.notes
                  ? `
                <div class="recovery-notes">
                  <i data-lucide="sticky-note"></i>
                  <span>${action.notes}</span>
                </div>
              `
                  : ""
              }
              ${
                action.obstacles
                  ? `
                <div class="recovery-obstacles">
                  <i data-lucide="alert-circle"></i>
                  <span>${action.obstacles}</span>
                </div>
              `
                  : ""
              }
            </div>
          </div>
        `
          )
          .join("");

        container.innerHTML = html;
        lucide.createIcons();
      }

      function addMilestone() {
        showNotification("Milestone creation form coming soon!", "info");
      }

      function addDelay() {
        showNotification("Delay reporting form coming soon!", "info");
      }

      function addRecoveryAction() {
        showNotification("Recovery action form coming soon!", "info");
      }

      // ===== PREVENT ACCIDENTAL NAVIGATION =====
      let formModified = false;
      window.addEventListener("beforeunload", (e) => {
        if (formModified) {
          e.preventDefault();
          e.returnValue = "";
        }
      });

      // ===== KEYBOARD SHORTCUTS =====
      document.addEventListener("keydown", (e) => {
        // Ctrl/Cmd + S to save
        if ((e.ctrlKey || e.metaKey) && e.key === "s") {
          e.preventDefault();
          document
            .getElementById("projectForm")
            .dispatchEvent(new Event("submit"));
        }
        // Ctrl/Cmd + K to toggle all sections
        if ((e.ctrlKey || e.metaKey) && e.key === "k") {
          e.preventDefault();
          const sections = document.querySelectorAll("[data-section]");
          sections.forEach((section) => {
            section.classList.toggle("collapsed");
          });
          lucide.createIcons();
        }
      });

      document.addEventListener("DOMContentLoaded", function () {
        loadSitioOptions();
        initFormInteractions();
        if (projectId) {
          document.getElementById("pageTitle").textContent = "Edit Project";
          document.getElementById("formTitle").textContent = "Edit Project";
          // Hide all dropdown fields when editing
          const dropdownFields = ["category", "sitio", "status"];
          dropdownFields.forEach((fieldId) => {
            const field = document.getElementById(fieldId);
            if (field) {
              const container = field.closest("div");
              if (container) {
                container.style.display = "none";
              }
            }
          });
          loadProjectData(projectId);
        } else {
          loadDraft(); // Load draft for new projects
        }
        updateProjectSummary();
        updateSectionStatus();
        lucide.createIcons(); // Initialize all icons
      });

      function loadSitioOptions() {
        const select = document.getElementById("sitio");
        select.innerHTML = '<option value="">Select Sitio</option>';
        window.mockData.sitios.forEach((sitio) => {
          sitioIndex[sitio.id] = sitio;
          const option = document.createElement("option");
          option.value = sitio.id;
          option.textContent = `${sitio.name} - ${sitio.municipality}`;
          select.appendChild(option);
        });
      }

      function initFormInteractions() {
        const summaryFields = document.querySelectorAll("[data-summary-field]");
        summaryFields.forEach((field) => {
          field.addEventListener("input", () => {
            if (field.id === "sitio") handleSitioChange();
            updateProjectSummary();
            formModified = true;
            autoSaveForm();
          });
          field.addEventListener("change", () => {
            if (field.id === "sitio") handleSitioChange();
            updateProjectSummary();
            formModified = true;
          });
          // Add blur validation
          field.addEventListener("blur", () => {
            validateField(field);
          });
        });

        // Currency input formatting
        const currencyInputs = document.querySelectorAll(".currency-input");
        currencyInputs.forEach((input) => {
          input.addEventListener("blur", () => {
            formatCurrencyInput(input);
            validateField(input);
          });
          input.addEventListener("focus", function () {
            // Remove formatting on focus for easier editing
            this.value = this.value.replace(/,/g, "");
          });
        });

        // Required fields validation
        const requiredFields = document.querySelectorAll("[required]");
        requiredFields.forEach((field) => {
          field.addEventListener("blur", () => {
            validateField(field);
          });
          field.addEventListener("input", () => {
            formModified = true;
            autoSaveForm();
          });
        });

        ["physical_plan", "physical_actual"].forEach((id) => {
          const el = document.getElementById(id);
          if (!el) return;
          el.addEventListener("input", () => {
            updateSlippage();
            updateProjectSummary();
            formModified = true;
            autoSaveForm();
          });
        });
      }

      function handleSitioChange() {
        const sitioId = document.getElementById("sitio").value;
        const municipioInput = document.getElementById("municipality");
        if (sitioIndex[sitioId]) {
          municipioInput.value = sitioIndex[sitioId].municipality;
        } else {
          municipioInput.value = "";
        }
      }

      function updateSlippage() {
        const plan = Number(
          document.getElementById("physical_plan").value || 0
        );
        const actual = Number(
          document.getElementById("physical_actual").value || 0
        );
        document.getElementById("physical_slippage").value = (
          actual - plan
        ).toFixed(2);
      }

      function loadProjectData(id) {
        const project = window.mockData.getProjectById(id);
        if (!project) {
          alert("Project not found");
          window.location.href = "project-list.html";
          return;
        }

        const monitoring = project.monitoring || {};
        const allotment = monitoring.allotment || {};
        const expenditure = monitoring.expenditure || {};
        const physical = monitoring.physical || {};
        const employment = monitoring.employment || {};
        const contract = monitoring.contract || {};
        const statusSummary = monitoring.statusSummary || {};

        document.getElementById("title").value = project.title;
        document.getElementById("description").value = project.description;
        document.getElementById("category").value = project.category;
        document.getElementById("project_year").value =
          project.project_year || new Date().getFullYear();
        document.getElementById("sitio").value = project.sitio_id;
        handleSitioChange();
        document.getElementById("status").value = project.status;
        document.getElementById("completion_percentage").value =
          project.completion_percentage;
        document.getElementById("start_date").value = project.start_date;
        document.getElementById("end_date").value = project.end_date;
        document.getElementById("implementing_agency").value =
          project.implementing_agency;
        document.getElementById("beneficiaries").value = project.beneficiaries;
        const budgetInput = document.getElementById("budget");
        budgetInput.value = project.budget;
        if (budgetInput.classList.contains("currency-input")) {
          formatCurrencyInput(budgetInput);
        }

        document.getElementById("fund_source").value =
          monitoring.fundSource || "20% LDF";
        document.getElementById("implementing_unit").value =
          monitoring.implementingUnit || "";

        // Format currency fields
        const currencyFields = [
          { id: "allotment_allocated", value: allotment.allocated },
          { id: "allotment_supplemental", value: allotment.supplemental },
          { id: "allotment_released", value: allotment.released },
          { id: "expenditure_obligations", value: expenditure.obligations },
          { id: "contract_cost", value: expenditure.contractCost },
        ];

        currencyFields.forEach((field) => {
          const input = document.getElementById(field.id);
          if (input && field.value != null) {
            input.value = field.value;
            if (input.classList.contains("currency-input")) {
              formatCurrencyInput(input);
            }
          }
        });

        document.getElementById("physical_plan").value = physical.plan ?? "";
        document.getElementById("physical_actual").value =
          physical.actual ?? "";
        document.getElementById("physical_slippage").value =
          physical.slippage ?? "";
        document.getElementById("employment_male").value =
          employment.male ?? "";
        document.getElementById("employment_female").value =
          employment.female ?? "";

        document.getElementById("contract_duration").value =
          contract.duration || "";
        document.getElementById("contract_delivery").value =
          contract.delivery || "";
        document.getElementById("contract_extension").value =
          contract.extension || "";
        document.getElementById("status_stage").value =
          statusSummary.stage || "";
        document.getElementById("status_issues").value =
          statusSummary.issues || "";
        document.getElementById("status_recommendations").value =
          statusSummary.recommendations || "";
        document.getElementById("catch_up_plan").value =
          monitoring.catchUpPlan || "";

        // Load accountability data
        if (project.accountability) {
          document.getElementById("project_manager").value =
            project.accountability.project_manager || "";
          document.getElementById("pm_agency").value =
            project.accountability.pm_agency || "Provincial Engineer's Office";
          document.getElementById("technical_lead").value =
            project.accountability.technical_lead || "";
          document.getElementById("contractor").value =
            project.accountability.contractor || "";
        }

        // Load milestone/delay/recovery data
        projectPhases = project.phases || [];
        projectMilestones = project.milestones || [];
        projectDelays = project.delays || [];
        projectRecoveryActions = project.recovery_actions || [];

        // Render milestone sections
        renderMilestones();
        renderDelays();
        renderRecoveryActions();

        updateSlippage();
        updateProjectSummary();
      }

      function updateProjectSummary() {
        const status = document.getElementById("status").value || "planning";
        const completion = Number(
          document.getElementById("completion_percentage").value || 0
        );
        const budgetInput = document.getElementById("budget");
        const budget = budgetInput.classList.contains("currency-input")
          ? getCurrencyValue(budgetInput)
          : Number(budgetInput.value || 0);
        const category = document.getElementById("category").value || "â€”";
        const sitioSelect = document.getElementById("sitio");
        const sitioText = sitioSelect.value
          ? sitioSelect.options[sitioSelect.selectedIndex].text.split(" - ")[0]
          : "â€”";
        const municipality =
          document.getElementById("municipality").value || "â€”";
        const startDate = document.getElementById("start_date").value;
        const endDate = document.getElementById("end_date").value;

        const allocatedInput = document.getElementById("allotment_allocated");
        const allocated = allocatedInput.classList.contains("currency-input")
          ? getCurrencyValue(allocatedInput) || budget
          : Number(allocatedInput.value || budget);

        const supplementalInput = document.getElementById(
          "allotment_supplemental"
        );
        const supplemental = supplementalInput.classList.contains(
          "currency-input"
        )
          ? getCurrencyValue(supplementalInput)
          : Number(supplementalInput.value || 0);

        const totalAllotted = allocated + supplemental;

        const releasedInput = document.getElementById("allotment_released");
        const released = releasedInput.classList.contains("currency-input")
          ? getCurrencyValue(releasedInput)
          : Number(releasedInput.value || 0);

        const obligatedInput = document.getElementById(
          "expenditure_obligations"
        );
        const obligated = obligatedInput.classList.contains("currency-input")
          ? getCurrencyValue(obligatedInput)
          : Number(obligatedInput.value || 0);
        const utilization = totalAllotted
          ? ((obligated / totalAllotted) * 100).toFixed(1)
          : "0.0";

        const stage =
          document.getElementById("status_stage").value ||
          getStatusLabel(status);
        const issues =
          document.getElementById("status_issues").value ||
          "No issues logged yet.";
        const catchup = document.getElementById("catch_up_plan").value || "N/A";

        const summaryStatus = document.getElementById("summaryStatus");
        summaryStatus.innerHTML = `<span class="badge ${getStatusBadgeClass(
          status
        )}">${getStatusLabel(status)}</span>`;
        document.getElementById(
          "summaryProgressValue"
        ).textContent = `${completion}%`;
        document.getElementById("summaryProgressBar").style.width = `${Math.min(
          100,
          completion
        )}%`;
        document.getElementById("summaryBudget").textContent = formatCurrency(
          budget || 0
        );
        document.getElementById("summaryCategory").textContent = category;
        document.getElementById(
          "summaryLocation"
        ).textContent = `${sitioText}, ${municipality}`;
        document.getElementById("summaryTimeline").textContent = startDate
          ? `${formatDate(startDate)} - ${
              endDate ? formatDate(endDate) : "TBD"
            }`
          : "Unset";
        document.getElementById("summaryAllotted").textContent = formatCurrency(
          totalAllotted || 0
        );
        document.getElementById("summaryReleased").textContent = formatCurrency(
          released || 0
        );
        document.getElementById("summaryObligated").textContent =
          formatCurrency(obligated || 0);
        document.getElementById(
          "summaryUtilization"
        ).textContent = `Utilization: ${utilization}% of allotted`;
        document.getElementById("summaryStage").textContent = stage;
        document.getElementById("summaryCatchup").textContent = catchup;
        document.getElementById("summaryIssues").textContent = issues;
      }

      document
        .getElementById("projectForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          // Validate all required fields
          const requiredFields = document.querySelectorAll("[required]");
          let allValid = true;
          requiredFields.forEach((field) => {
            if (!validateField(field)) {
              allValid = false;
            }
          });

          if (!allValid) {
            showNotification(
              "Please fill in all required fields correctly",
              "error"
            );
            // Scroll to first error
            const firstError = document.querySelector(".has-error");
            if (firstError) {
              firstError.scrollIntoView({
                behavior: "smooth",
                block: "center",
              });
              firstError.focus();
            }
            return;
          }

          // Clear draft and form modified flag
          formModified = false;
          const draftKey = projectId
            ? `project-draft-${projectId}`
            : "project-draft-new";
          localStorage.removeItem(draftKey);

          showToast(
            projectId
              ? "Project updated successfully"
              : "Project created successfully",
            "success"
          );
          setTimeout(() => (window.location.href = "project-list.html"), 1500);
        });
    </script>
  </body>
</html>
