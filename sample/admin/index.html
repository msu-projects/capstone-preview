<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - South Cotabato Data Bank</title>

    <!-- CSS -->
    <link rel="stylesheet" href="../assets/css/variables.css" />
    <link rel="stylesheet" href="../assets/css/base.css" />
    <link rel="stylesheet" href="../assets/css/components.css" />
    <link rel="stylesheet" href="../assets/css/utilities.css" />
    <link rel="stylesheet" href="../assets/css/admin.css" />
  </head>
  <body>
    <div class="admin-layout">
      <!-- Sidebar -->
      <aside class="admin-sidebar">
        <div class="admin-sidebar-header">
          <a href="index.html" class="admin-logo">
            <i data-lucide="database"></i>
            <span>SC Data Bank</span>
          </a>
        </div>

        <nav class="admin-nav">
          <div class="admin-nav-section">
            <div class="admin-nav-title">Main</div>
            <a href="index.html" class="admin-nav-link active">
              <i data-lucide="layout-dashboard"></i>
              <span>Dashboard</span>
            </a>
          </div>

          <div class="admin-nav-section">
            <div class="admin-nav-title">Data Management</div>
            <a href="sitio-list.html" class="admin-nav-link">
              <i data-lucide="map-pin"></i>
              <span>Sitios</span>
            </a>
            <a href="project-list.html" class="admin-nav-link">
              <i data-lucide="folder"></i>
              <span>Projects</span>
            </a>
            <a href="import.html" class="admin-nav-link">
              <i data-lucide="upload-cloud"></i>
              <span>Import Data</span>
            </a>
          </div>

          <div class="admin-nav-section">
            <div class="admin-nav-title">System</div>
            <a href="users.html" class="admin-nav-link">
              <i data-lucide="users"></i>
              <span>Users</span>
            </a>
            <a href="../public/index.html" class="admin-nav-link">
              <i data-lucide="external-link"></i>
              <span>View Public Portal</span>
            </a>
          </div>
        </nav>

        <div class="admin-sidebar-footer">
          <div class="admin-user-info">
            <div class="admin-user-avatar">A</div>
            <div class="admin-user-details">
              <div class="admin-user-name">Admin User</div>
              <div class="admin-user-role">Administrator</div>
            </div>
            <button class="btn-icon btn-ghost" onclick="logout()">
              <i data-lucide="log-out"></i>
            </button>
          </div>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="admin-main">
        <!-- Header -->
        <header class="admin-header">
          <div class="admin-header-content">
            <h1 class="admin-page-title">Dashboard</h1>
            <div class="admin-header-actions">
              <button class="btn btn-outline btn-sm">
                <i data-lucide="download"></i>
                <span>Export Report</span>
              </button>
              <button
                class="btn btn-primary btn-sm"
                onclick="window.location.href='project-form.html'"
              >
                <i data-lucide="plus"></i>
                <span>New Project</span>
              </button>
            </div>
          </div>
        </header>

        <!-- Content -->
        <div class="admin-content">
          <!-- Stats Grid -->
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-card-header">
                <div class="stat-card-title">Total Sitios</div>
                <div class="stat-card-icon primary">
                  <i data-lucide="map-pin"></i>
                </div>
              </div>
              <div class="stat-card-value" id="totalSitios">0</div>
              <div class="stat-card-change positive">
                <i data-lucide="trending-up"></i>
                <span>5 added this month</span>
              </div>
            </div>

            <div class="stat-card">
              <div class="stat-card-header">
                <div class="stat-card-title">Active Projects</div>
                <div class="stat-card-icon warning">
                  <i data-lucide="activity"></i>
                </div>
              </div>
              <div class="stat-card-value" id="activeProjects">0</div>
              <div class="stat-card-change positive">
                <i data-lucide="trending-up"></i>
                <span>In progress</span>
              </div>
            </div>

            <div class="stat-card">
              <div class="stat-card-header">
                <div class="stat-card-title">Completed Projects</div>
                <div class="stat-card-icon success">
                  <i data-lucide="check-circle"></i>
                </div>
              </div>
              <div class="stat-card-value" id="completedProjects">0</div>
              <div class="stat-card-change positive">
                <i data-lucide="trending-up"></i>
                <span>This year</span>
              </div>
            </div>

            <div class="stat-card">
              <div class="stat-card-header">
                <div class="stat-card-title">Total Beneficiaries</div>
                <div class="stat-card-icon primary">
                  <i data-lucide="users"></i>
                </div>
              </div>
              <div class="stat-card-value" id="totalBeneficiaries">0</div>
              <div class="stat-card-change positive">
                <i data-lucide="trending-up"></i>
                <span>Across all projects</span>
              </div>
            </div>
          </div>

          <!-- Main Grid -->
          <div
            style="
              display: grid;
              grid-template-columns: 2fr 1fr;
              gap: 1.5rem;
              margin-top: 1.5rem;
            "
          >
            <!-- Recent Projects -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Recent Projects</h3>
                <a href="project-list.html" class="btn btn-ghost btn-sm">
                  View All
                  <i data-lucide="arrow-right"></i>
                </a>
              </div>
              <div class="card-content" style="padding: 0">
                <div
                  class="table-container"
                  style="border: none; border-radius: 0"
                >
                  <table class="table">
                    <thead>
                      <tr>
                        <th>Project</th>
                        <th>Sitio</th>
                        <th>Status</th>
                        <th>Progress</th>
                      </tr>
                    </thead>
                    <tbody id="recentProjects">
                      <!-- Populated by JavaScript -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- Activity Feed -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Recent Activity</h3>
              </div>
              <div class="card-content" style="padding: 0">
                <div class="activity-feed" id="activityFeed">
                  <!-- Populated by JavaScript -->
                </div>
              </div>
            </div>
          </div>

          <!-- Quick Stats -->
          <div
            style="
              display: grid;
              grid-template-columns: repeat(2, 1fr);
              gap: 1.5rem;
              margin-top: 1.5rem;
            "
          >
            <!-- Projects by Status -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Projects by Status</h3>
              </div>
              <div class="card-content">
                <div id="statusBreakdown">
                  <!-- Populated by JavaScript -->
                </div>
              </div>
            </div>

            <!-- Projects by Category -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Top Categories</h3>
              </div>
              <div class="card-content">
                <div id="categoryBreakdown">
                  <!-- Populated by JavaScript -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="../assets/js/icons.js"></script>
    <script src="../assets/js/main.js"></script>
    <script src="../assets/js/mock-data.js"></script>

    <!-- Dashboard Script -->
    <script>
      // Check authentication
      if (!localStorage.getItem("isLoggedIn")) {
        window.location.href = "login.html";
      }

      // Load dashboard data
      document.addEventListener("DOMContentLoaded", function () {
        loadStats();
        loadRecentProjects();
        loadActivityFeed();
        loadStatusBreakdown();
        loadCategoryBreakdown();
      });

      function loadStats() {
        const stats = window.mockData.stats;
        document.getElementById("totalSitios").textContent = formatNumber(
          stats.total_sitios
        );
        document.getElementById("activeProjects").textContent = formatNumber(
          stats.active_projects
        );
        document.getElementById("completedProjects").textContent = formatNumber(
          stats.completed_projects
        );
        document.getElementById("totalBeneficiaries").textContent =
          formatNumber(stats.total_beneficiaries);
      }

      function loadRecentProjects() {
        const projects = window.mockData.projects.slice(0, 5);
        const tbody = document.getElementById("recentProjects");

        tbody.innerHTML = projects
          .map(
            (project) => `
        <tr onclick="window.location.href='project-form.html?id=${
          project.id
        }'" style="cursor: pointer;">
          <td>
            <div style="font-weight: 500;">${truncateText(
              project.title,
              40
            )}</div>
            <div style="font-size: var(--text-xs); color: hsl(var(--muted-foreground));">${
              project.category
            }</div>
          </td>
          <td>${project.sitio_name}</td>
          <td>
            <span class="badge ${getStatusBadgeClass(project.status)}">
              ${getStatusLabel(project.status)}
            </span>
          </td>
          <td>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <div style="flex: 1; height: 0.5rem; background: hsl(var(--muted)); border-radius: 999px; overflow: hidden;">
                <div style="height: 100%; width: ${
                  project.completion_percentage
                }%; background: hsl(var(--primary)); transition: width 0.3s;"></div>
              </div>
              <span style="font-size: var(--text-xs); color: hsl(var(--muted-foreground)); min-width: 3rem;">${
                project.completion_percentage
              }%</span>
            </div>
          </td>
        </tr>
      `
          )
          .join("");

        refreshIcons();
      }

      function loadActivityFeed() {
        const activities = window.mockData.activities;
        const feed = document.getElementById("activityFeed");

        feed.innerHTML = activities
          .map(
            (activity) => `
        <div class="activity-item">
          <div class="activity-icon">
            <i data-lucide="${activity.icon}"></i>
          </div>
          <div class="activity-content">
            <div class="activity-title">${activity.user}</div>
            <div class="activity-description">${activity.action}: ${
              activity.target
            }</div>
            <div class="activity-time">${formatActivityTime(
              activity.timestamp
            )}</div>
          </div>
        </div>
      `
          )
          .join("");

        refreshIcons();
      }

      function loadStatusBreakdown() {
        const stats = window.mockData.stats;
        const container = document.getElementById("statusBreakdown");

        const statuses = [
          {
            label: "Planning",
            count: stats.planning_projects,
            color: "var(--status-planning)",
          },
          {
            label: "In Progress",
            count: stats.active_projects,
            color: "var(--status-progress)",
          },
          {
            label: "Completed",
            count: stats.completed_projects,
            color: "var(--status-completed)",
          },
          {
            label: "Suspended",
            count: stats.suspended_projects,
            color: "var(--destructive)",
          },
        ];

        container.innerHTML = statuses
          .map(
            (status) => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid hsl(var(--border));">
          <div style="display: flex; align-items: center; gap: 0.75rem;">
            <div style="width: 0.75rem; height: 0.75rem; border-radius: 50%; background: hsl(${status.color});"></div>
            <span style="font-size: var(--text-sm);">${status.label}</span>
          </div>
          <span style="font-size: var(--text-lg); font-weight: var(--font-semibold);">${status.count}</span>
        </div>
      `
          )
          .join("");
      }

      function loadCategoryBreakdown() {
        const chartData = window.mockData.chartData.projectsByCategory;
        const container = document.getElementById("categoryBreakdown");

        const sorted = chartData.sort((a, b) => b.count - a.count).slice(0, 5);
        const maxCount = Math.max(...sorted.map((c) => c.count));

        container.innerHTML = sorted
          .map(
            (cat) => `
        <div style="margin-bottom: 1rem;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
            <span style="font-size: var(--text-sm); font-weight: 500;">${
              cat.category
            }</span>
            <span style="font-size: var(--text-sm); color: hsl(var(--muted-foreground));">${
              cat.count
            }</span>
          </div>
          <div style="height: 0.5rem; background: hsl(var(--muted)); border-radius: 999px; overflow: hidden;">
            <div style="height: 100%; width: ${
              (cat.count / maxCount) * 100
            }%; background: hsl(var(--primary)); transition: width 0.3s;"></div>
          </div>
        </div>
      `
          )
          .join("");
      }

      function formatActivityTime(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 60) return `${diffMins} minutes ago`;
        if (diffHours < 24) return `${diffHours} hours ago`;
        return `${diffDays} days ago`;
      }

      function logout() {
        localStorage.removeItem("isLoggedIn");
        localStorage.removeItem("userEmail");
        localStorage.removeItem("userName");
        window.location.href = "login.html";
      }
    </script>
  </body>
</html>
