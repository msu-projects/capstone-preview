// ============================================
// SC CATCH-UP 2025 Project Tracking System
// Entity-Relationship Diagram (DBML)
// ============================================
// Normalized schema with proper relational tables
// for project tracking data.
// ============================================

Project sc_catchup_2025 {
  database_type: 'PostgreSQL'
  Note: 'South Cotabato CATCH-UP 2025 Project Tracking System - Sitio profiling and project monitoring'
}

// ============================================
// ENUMS
// ============================================

enum project_status {
  planning [note: 'Project is in planning phase']
  in_progress [note: 'Project is currently being implemented']
  completed [note: 'Project has been completed']
  suspended [note: 'Project is temporarily suspended']
}

enum official_type {
  local [note: 'Local barangay/sitio official']
  rst [note: 'Resident Support Team official']
}

enum user_role {
  superadmin [note: 'Full system access']
  admin [note: 'Can manage sitios and projects']
  viewer [note: 'Read-only access']
}

enum audit_action {
  login
  logout
  create
  update
  delete
  view
  export
  import
}

enum audit_resource_type {
  user
  sitio
  project
  system
}

enum funding_source_type {
  provincial [note: 'Provincial government funds']
  national [note: 'National government funds']
  partner [note: 'Partner organization funds']
  lgu_counterpart [note: 'Local government unit counterpart']
}

enum progress_status {
  on_track [note: 'Project is on schedule']
  delayed [note: 'Project is behind schedule']
  ahead [note: 'Project is ahead of schedule']
}

enum storage_type {
  indexeddb [note: 'Stored in browser IndexedDB']
  server [note: 'Stored on server']
}

// ============================================
// LOCATION HIERARCHY
// ============================================


Table municipalities {
  id integer [pk, increment]
  name varchar(100) [not null]
  //psgc_code varchar(10) [unique, note: 'Philippine Standard Geographic Code']
  
  indexes {
  }
  
  Note: 'Municipality/City reference table'
}

Table barangays {
  id integer [pk, increment]
  municipality_id integer [not null, ref: > municipalities.id]
  name varchar(100) [not null]
  //psgc_code varchar(10) [unique, note: 'Philippine Standard Geographic Code']
  
  indexes {
    municipality_id [name: 'idx_barangays_municipality']
    (municipality_id, name) [unique, name: 'idx_barangays_unique_name']
  }
  
  Note: 'Barangay reference table'
}

// ============================================
// CORE ENTITIES
// ============================================

Table sitios {
  id integer [pk, increment]
  name varchar(255) [not null]
  barangay_id integer [not null, ref: > barangays.id]
  coordinates_lat decimal [not null]
  coordinates_lng decimal [not null]
  coding varchar(50) [note: 'Sitio code identifier']
  
  created_at timestamp [not null, default: `now()`]
  updated_at timestamp
  
  indexes {
    barangay_id [name: 'idx_sitios_barangay']
    name [name: 'idx_sitios_name']
    (barangay_id, name) [unique, name: 'idx_sitios_unique_name']
  }
  
  Note: 'Core sitio (community) entity - contains only identification and location data'
}

Table sitio_data {
  id integer [pk, increment]
  sitio_id integer [not null, ref: > sitios.id]
  year_recorded integer [not null, note: 'Year this data was recorded']
  //is_current boolean [not null, default: false, note: 'Whether this is the current/active data for the sitio']
  recorded_at timestamp [not null, default: `now()`]
  
  // Core metrics
  population integer [not null, default: 0]
  households integer [not null, default: 0]
  
  // Need assessment
  need_score decimal [note: 'Admin-assigned need score 1-10']
  
  // Demographics (flattened)
  male integer [not null, default: 0]
  female integer [not null, default: 0]
  age_0_14 integer [not null, default: 0]
  age_15_64 integer [not null, default: 0]
  age_65_above integer [not null, default: 0]
  
  // Social services (flattened)
  registered_voters integer [default: 0]
  philhealth_beneficiaries integer [default: 0]
  fourps_beneficiaries integer [default: 0]
  
  // Agriculture (flattened - arrays normalized to separate tables)
  farmers_count integer [default: 0]
  farmer_associations integer [default: 0]
  farm_area_hectares decimal [default: 0]
  
  // Water and sanitation (flattened - arrays normalized)
  water_systems_count integer [default: 0]
  households_without_toilet integer [default: 0]
  waste_segregation_practice boolean
  
  // Food security (flattened - arrays normalized)
  households_with_backyard_garden integer [default: 0]
  
  // Domestic animals (flattened)
  dogs integer [default: 0]
  cats integer [default: 0]
  dogs_vaccinated integer [default: 0]
  cats_vaccinated integer [default: 0]
  
  // Community empowerment (flattened - arrays normalized)
  sectoral_organizations integer [default: 0]
  
  // Utilities (flattened - arrays normalized)
  households_with_electricity integer [default: 0]
  
  Note: 'Sitio profiling data with year-over-year tracking. is_current=true indicates the active data for the sitio.'
}

// ============================================
// ISSUES AND CONCERNS / PROPOSED PPA (Normalized)
// ============================================

Table sitio_data_issues_concerns {
  id integer [pk, increment]
  sitio_data_id integer [not null, ref: > sitio_data.id]
  name varchar(255) [not null]
  category varchar(100) [not null]
  is_custom boolean [not null, default: false]
  
  indexes {
    sitio_data_id [name: 'idx_sitio_issues_concerns_data']
    category [name: 'idx_sitio_issues_concerns_category']
  }
  
  Note: 'Issues and concerns identified in the sitio'
}

Table sitio_data_proposed_ppas {
  id integer [pk, increment]
  sitio_data_id integer [not null, ref: > sitio_data.id]
  name varchar(255) [not null]
  category varchar(100) [not null]
  is_custom boolean [not null, default: false]
  project_type_id integer [ref: > project_types.id, note: 'Link to project type if applicable']
  
  indexes {
    sitio_data_id [name: 'idx_sitio_proposed_ppas_data']
    category [name: 'idx_sitio_proposed_ppas_category']
    project_type_id [name: 'idx_sitio_proposed_ppas_project_type']
  }
  
  Note: 'Proposed Programs, Projects, and Activities for the sitio'
}

Table sitio_data_issue_ppa_links {
  id integer [pk, increment]
  issue_id integer [not null, ref: > sitio_data_issues_concerns.id]
  ppa_id integer [not null, ref: > sitio_data_proposed_ppas.id]
  
  indexes {
    issue_id [name: 'idx_issue_ppa_links_issue']
    ppa_id [name: 'idx_issue_ppa_links_ppa']
    (issue_id, ppa_id) [unique, name: 'idx_issue_ppa_links_unique']
  }
  
  Note: 'Many-to-many linking between issues/concerns and proposed PPAs'
}

// ============================================
// SITIO DATA NORMALIZED ARRAYS
// ============================================

Table sitio_data_employments {
  id integer [pk, increment]
  sitio_data_id integer [not null, ref: > sitio_data.id]
  type varchar(100) [not null]
  count integer [not null, default: 0]
  
  indexes {
    sitio_data_id [name: 'idx_sitio_employments_data']
  }
  
  Note: 'Employment types and counts for sitio data'
}

Table sitio_data_income_brackets {
  id integer [pk, increment]
  sitio_data_id integer [not null, ref: > sitio_data.id]
  bracket varchar(100) [not null]
  households integer [not null, default: 0]
  
  indexes {
    sitio_data_id [name: 'idx_sitio_income_brackets_data']
  }
  
  Note: 'Income bracket distribution for sitio data'
}

Table sitio_data_top_crops {
  id integer [pk, increment]
  sitio_data_id integer [not null, ref: > sitio_data.id]
  crop_name varchar(100) [not null]
  
  indexes {
    sitio_data_id [name: 'idx_sitio_top_crops_data']
  }
  
  Note: 'Top crops grown in sitio'
}

Table sitio_data_water_sources {
  id integer [pk, increment]
  sitio_data_id integer [not null, ref: > sitio_data.id]
  source varchar(100) [not null]
  status varchar(50) [not null]
  
  indexes {
    sitio_data_id [name: 'idx_sitio_water_sources_data']
  }
  
  Note: 'Water sources and their status for sitio'
}

Table sitio_data_toilet_types {
  id integer [pk, increment]
  sitio_data_id integer [not null, ref: > sitio_data.id]
  type varchar(100) [not null]
  
  indexes {
    sitio_data_id [name: 'idx_sitio_toilet_types_data']
  }
  
  Note: 'Toilet facility types in sitio'
}

Table sitio_data_livestock {
  id integer [pk, increment]
  sitio_data_id integer [not null, ref: > sitio_data.id]
  animal_type varchar(100) [not null]
  
  indexes {
    sitio_data_id [name: 'idx_sitio_livestock_data']
  }
  
  Note: 'Livestock and poultry types in sitio'
}

Table sitio_data_garden_commodities {
  id integer [pk, increment]
  sitio_data_id integer [not null, ref: > sitio_data.id]
  commodity varchar(100) [not null]
  
  indexes {
    sitio_data_id [name: 'idx_sitio_garden_commodities_data']
  }
  
  Note: 'Common garden commodities grown in sitio'
}

Table sitio_data_housing_quality {
  id integer [pk, increment]
  sitio_data_id integer [not null, ref: > sitio_data.id]
  type varchar(100) [not null]
  count integer [not null, default: 0]
  
  indexes {
    sitio_data_id [name: 'idx_sitio_housing_quality_data']
  }
  
  Note: 'Housing quality types and counts'
}

Table sitio_data_housing_ownership {
  id integer [pk, increment]
  sitio_data_id integer [not null, ref: > sitio_data.id]
  type varchar(100) [not null]
  count integer [not null, default: 0]
  
  indexes {
    sitio_data_id [name: 'idx_sitio_housing_ownership_data']
  }
  
  Note: 'Housing ownership types and counts'
}

Table sitio_data_info_methods {
  id integer [pk, increment]
  sitio_data_id integer [not null, ref: > sitio_data.id]
  method varchar(100) [not null]
  
  indexes {
    sitio_data_id [name: 'idx_sitio_info_methods_data']
  }
  
  Note: 'Information dissemination methods used in sitio'
}

Table sitio_data_transport_methods {
  id integer [pk, increment]
  sitio_data_id integer [not null, ref: > sitio_data.id]
  method varchar(100) [not null]
  
  indexes {
    sitio_data_id [name: 'idx_sitio_transport_methods_data']
  }
  
  Note: 'Transportation methods used in sitio'
}

Table sitio_data_electricity_sources {
  id integer [pk, increment]
  sitio_data_id integer [not null, ref: > sitio_data.id]
  source varchar(100) [not null]
  
  indexes {
    sitio_data_id [name: 'idx_sitio_electricity_sources_data']
  }
  
  Note: 'Alternative electricity sources in sitio'
}

Table sitio_data_ethnicities {
  id integer [pk, increment]
  sitio_data_id integer [not null, ref: > sitio_data.id]
  ethnicity varchar(100) [not null]
  
  indexes {
    sitio_data_id [name: 'idx_sitio_ethnicities_data']
  }
  
  Note: 'Ethnic groups represented in sitio'
}

Table sitio_data_religions {
  id integer [pk, increment]
  sitio_data_id integer [not null, ref: > sitio_data.id]
  religion varchar(100) [not null]
  
  indexes {
    sitio_data_id [name: 'idx_sitio_religions_data']
  }
  
  Note: 'Religious affiliations in sitio'
}

Table sitio_data_officials {
  id integer [pk, increment]
  sitio_data_id integer [not null, ref: > sitio_data.id]
  name varchar(255) [not null]
  position varchar(100) [not null]
  official_type official_type [not null]
  
  indexes {
    sitio_data_id [name: 'idx_sitio_officials_data']
  }
  
  Note: 'Local and RST officials for sitio'
}

// ============================================
// CORE ENTITIES (continued)
// ============================================

Table projects {
  id integer [pk, increment]
  title varchar(500) [not null]
  description text
  category_key varchar(50) [not null, note: 'FK to categories.key']
  project_type_id integer [ref: > project_types.id]
  status project_status [not null, default: 'planning']
  start_date date [not null]
  contract_duration varchar(50) [note: 'e.g., "180 CD" for calendar days']
  total_budget decimal [not null, default: 0]
  contract_cost decimal [not null, default: 0]
  beneficiaries integer [not null, default: 0]
  project_year integer [not null]

  
  implementing_agency varchar(100)
  
  created_at timestamp [not null, default: `now()`]
  updated_at timestamp
  
  indexes {
    status [name: 'idx_projects_status']
    category_key [name: 'idx_projects_category']
    project_year [name: 'idx_projects_year']
    start_date [name: 'idx_projects_start_date']
  }
  
  Note: 'Main project entity - related data normalized into separate tables'
}

Table users {
  id integer [pk, increment]
  name varchar(255) [not null]
  email varchar(255) [unique, not null]
  password_hash varchar(255) [not null]
  role user_role [not null, default: 'viewer']
  department varchar(100)
  is_active boolean [not null, default: true]
  
  // JSONB for flexible permissions (kept as JSONB for flexibility)
  permissions jsonb [not null, note: '{ sitios: {read, write, delete}, projects: {...}, users: {...}, audit_logs: {...} }']
  
  last_login timestamp
  created_at timestamp [not null, default: `now()`]
  updated_at timestamp
  
  indexes {
    email [unique, name: 'idx_users_email']
    role [name: 'idx_users_role']
    is_active [name: 'idx_users_active']
  }
  
  Note: 'System users with role-based access control and granular permissions'
}

// ============================================
// REFERENCE DATA
// ============================================

Table categories {
  id integer [pk, increment]
  key varchar(50) [unique, not null]
  name varchar(100) [not null]
  description text
  icon varchar(50) [note: 'Icon identifier for UI']
  
  Note: 'Project category reference table'
}

Table project_types {
  id integer [pk, increment]
  category_key varchar(50) [not null, ref: > categories.key]
  name varchar(255) [not null]
  description text
  default_indicators jsonb [note: '[{ id, name, unit, description }]']
  
  indexes {
    category_key [name: 'idx_project_types_category']
  }
  
  Note: 'Specific project types within each category'
}

Table performance_targets {
  id integer [pk, increment]
  project_id integer [not null, ref: > projects.id]
  indicator_type varchar(100) [not null, note: 'Type/category of indicator']
  indicator_name varchar(255) [not null, note: 'Display name']
  target_value decimal [not null]
  unit_of_measure varchar(50) [not null]
  
  created_at timestamp [not null, default: `now()`]
  updated_at timestamp
  
  indexes {
    project_id [name: 'idx_performance_targets_project']
  }
  
  Note: 'Performance indicator targets for projects'
}

// ============================================
// PROJECT FINANCIAL TRACKING (Normalized 1:1)
// ============================================

Table project_employment {
  id integer [pk, increment]
  project_id integer [not null, ref: > projects.id, unique]
  male integer [not null, default: 0]
  female integer [not null, default: 0]
  
  created_at timestamp [not null, default: `now()`]
  updated_at timestamp
  
  indexes {
    project_id [name: 'idx_employment_project']
  }
  
  Note: 'Employment generated per project (1:1 relationship)'
}

// ============================================
// PROJECT TRACKING (Many-to-One)
// ============================================

Table project_sitios {
  project_id integer [not null, ref: > projects.id]
  sitio_id integer [not null, ref: > sitios.id]
  beneficiaries_target integer [default: 0]
  focal_person varchar(255)
  focal_contact varchar(100)
  
  indexes {
    (project_id, sitio_id) [pk]
    sitio_id [name: 'idx_project_sitios_sitio']
  }
  
  Note: 'Junction table linking projects to sitios (many-to-many)'
}

Table monthly_targets {
  id integer [pk, increment]
  project_id integer [not null, ref: > projects.id]
  month_year varchar(7) [not null, note: 'Format: YYYY-MM']
  planned_physical_progress decimal [not null, default: 0, note: 'Planned cumulative physical progress %']
  planned_budget decimal [not null, default: 0, note: 'Planned budget release for the month']
  
  created_at timestamp [not null, default: `now()`]
  updated_at timestamp
  
  indexes {
    project_id [name: 'idx_monthly_targets_project']
    (project_id, month_year) [unique, name: 'idx_monthly_targets_unique']
  }
  
  Note: 'Monthly planned targets for physical progress and budget (planning phase)'
}

Table monthly_progress {
  id integer [pk, increment]
  project_id integer [not null, ref: > projects.id]
  month_year varchar(7) [not null, note: 'Format: YYYY-MM']
  physical_progress_percentage decimal [not null, default: 0, note: 'Actual physical progress %']
  budget_utilized decimal [not null, default: 0, note: 'Actual budget utilized this month']
  beneficiaries_reached integer [default: 0]
  achieved_outputs jsonb [note: '{ indicator_key: achieved_value }']
  issues text [note: 'Issues encountered']
  recommendations text [note: 'Recommended actions']
  catch_up_plan text [note: 'Plan to catch up if delayed']
  status progress_status [not null, default: 'on_track']
  
  created_at timestamp [not null, default: `now()`]
  updated_at timestamp
  
  indexes {
    project_id [name: 'idx_monthly_progress_project']
    month_year [name: 'idx_monthly_progress_month']
    (project_id, month_year) [unique, name: 'idx_monthly_progress_unique']
  }
  
  Note: 'Actual monthly progress tracking with physical progress and budget utilized'
}

Table photo_documentation {
  id varchar(21) [pk, note: 'nanoid']
  monthly_progress_id integer [not null, ref: > monthly_progress.id]
  filename varchar(255) [not null]
  caption text
  thumbnail_id varchar(21) [note: 'Reference to thumbnail']
  uploaded_at timestamp [not null, default: `now()`]
  
  indexes {
    monthly_progress_id [name: 'idx_photos_progress']
  }
  
  Note: 'Photo documentation attached to monthly progress'
}

Table budget_components {
  id integer [pk, increment]
  project_id integer [not null, ref: > projects.id]
  component_name varchar(255) [not null]
  amount decimal [not null, default: 0]
  
  indexes {
    project_id [name: 'idx_budget_components_project']
  }
  
  Note: 'Budget breakdown by component for each project'
}

Table funding_sources {
  id integer [pk, increment]
  project_id integer [not null, ref: > projects.id]
  source_name varchar(255) [not null]
  source_type funding_source_type [not null]
  amount decimal [not null, default: 0]
  
  indexes {
    project_id [name: 'idx_funding_sources_project']
    source_type [name: 'idx_funding_sources_type']
  }
  
  Note: 'Funding sources contributing to each project'
}

// ============================================
// SYSTEM / AUDIT
// ============================================

Table audit_logs {
  id varchar(21) [pk, note: 'nanoid']
  user_id integer [ref: > users.id]
  user_name varchar(255) [not null, note: 'Denormalized for historical accuracy']
  action audit_action [not null]
  resource_type audit_resource_type [not null]
  resource_id varchar(50) [note: 'ID of affected resource']
  resource_name varchar(255) [note: 'Name/title of affected resource']
  details text [note: 'Additional context or changes summary']
  changes jsonb [note: '[{ field, oldValue, newValue }]']
  ip_address varchar(45)
  timestamp timestamp [not null, default: `now()`]
  
  indexes {
    timestamp [name: 'idx_audit_logs_timestamp']
    user_id [name: 'idx_audit_logs_user']
    resource_type [name: 'idx_audit_logs_resource_type']
    action [name: 'idx_audit_logs_action']
  }
  
  Note: 'Comprehensive audit trail for all system actions'
}

// ============================================
// TABLE GROUPS (for diagram organization)
// ============================================

TableGroup location_hierarchy [color: #f39c12] {
  municipalities
  barangays
}

TableGroup core_entities [color: #3498db] {
  sitios
  sitio_data
  projects
  users
}

TableGroup sitio_profiling [color: #e67e22] {
  sitio_data_employments
  sitio_data_income_brackets
  sitio_data_top_crops
  sitio_data_water_sources
  sitio_data_toilet_types
  sitio_data_livestock
  sitio_data_garden_commodities
  sitio_data_housing_quality
  sitio_data_housing_ownership
  sitio_data_info_methods
  sitio_data_transport_methods
  sitio_data_electricity_sources
  sitio_data_ethnicities
  sitio_data_religions
  sitio_data_officials
}

TableGroup reference_data [color: #9b59b6] {
  categories
  project_types
  performance_targets
}

TableGroup project_financials [color: #1abc9c] {
  project_employment
  budget_components
  funding_sources
}

TableGroup project_tracking [color: #2ecc71] {
  project_sitios
  monthly_targets
  monthly_progress
  photo_documentation  
}

TableGroup system [color: #e74c3c] {
  audit_logs
}
