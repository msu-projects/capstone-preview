// ============================================
// SC CATCH-UP 2025 Project Tracking System
// Entity-Relationship Diagram (DBML)
// ============================================
// Normalized schema with proper relational tables
// for project tracking data.
// ============================================

Project sc_catchup_2025 {
  database_type: 'PostgreSQL'
  Note: 'South Cotabato CATCH-UP 2025 Project Tracking System - Sitio profiling and project monitoring'
}

// ============================================
// ENUMS
// ============================================

enum project_status {
  planning [note: 'Project is in planning phase']
  in_progress [note: 'Project is currently being implemented']
  completed [note: 'Project has been completed']
  suspended [note: 'Project is temporarily suspended']
}

enum priority_level {
  high
  medium
  low
}

enum category_key {
  infrastructure
  agriculture
  education
  health
  livelihood
  environment
}

enum user_role {
  superadmin [note: 'Full system access']
  admin [note: 'Can manage sitios and projects']
  viewer [note: 'Read-only access']
}

enum audit_action {
  login
  logout
  create
  update
  delete
  view
  export
  import
}

enum audit_resource_type {
  user
  sitio
  project
  system
}

enum funding_source_type {
  provincial [note: 'Provincial government funds']
  national [note: 'National government funds']
  partner [note: 'Partner organization funds']
  lgu_counterpart [note: 'Local government unit counterpart']
}

enum progress_status {
  on_track [note: 'Project is on schedule']
  delayed [note: 'Project is behind schedule']
  ahead [note: 'Project is ahead of schedule']
}

enum storage_type {
  indexeddb [note: 'Stored in browser IndexedDB']
  server [note: 'Stored on server']
}

// ============================================
// LOCATION HIERARCHY
// ============================================

Table provinces {
  id integer [pk, increment]
  name varchar(100) [unique, not null]
  psgc_code varchar(10) [unique, note: 'Philippine Standard Geographic Code']
  
  Note: 'Province reference table'
}

Table municipalities {
  id integer [pk, increment]
  province_id integer [not null, ref: > provinces.id]
  name varchar(100) [not null]
  psgc_code varchar(10) [unique, note: 'Philippine Standard Geographic Code']
  
  indexes {
    province_id [name: 'idx_municipalities_province']
    (province_id, name) [unique, name: 'idx_municipalities_unique_name']
  }
  
  Note: 'Municipality/City reference table'
}

Table barangays {
  id integer [pk, increment]
  municipality_id integer [not null, ref: > municipalities.id]
  name varchar(100) [not null]
  psgc_code varchar(10) [unique, note: 'Philippine Standard Geographic Code']
  
  indexes {
    municipality_id [name: 'idx_barangays_municipality']
    (municipality_id, name) [unique, name: 'idx_barangays_unique_name']
  }
  
  Note: 'Barangay reference table'
}

// ============================================
// CORE ENTITIES
// ============================================

Table sitios {
  id integer [pk, increment]
  name varchar(255) [not null]
  barangay_id integer [not null, ref: > barangays.id]
  coordinates_lat decimal(10,8) [not null]
  coordinates_lng decimal(11,8) [not null]
  coding varchar(50) [note: 'Sitio code identifier']
  
  created_at timestamp [not null, default: `now()`]
  updated_at timestamp
  
  indexes {
    barangay_id [name: 'idx_sitios_barangay']
    name [name: 'idx_sitios_name']
    (barangay_id, name) [unique, name: 'idx_sitios_unique_name']
  }
  
  Note: 'Core sitio (community) entity - contains only identification and location data'
}

Table sitio_data {
  id integer [pk, increment]
  sitio_id integer [not null, ref: > sitios.id]
  year integer [not null, note: 'Year this data was recorded']
  is_current boolean [not null, default: false, note: 'Whether this is the current/active data for the sitio']
  recorded_at timestamp [not null, default: `now()`]
  
  // Core metrics
  population integer [not null, default: 0]
  households integer [not null, default: 0]
  
  // JSONB columns for embedded profiling data
  demographics jsonb [not null, note: '{ male, female, total, age_0_14, age_15_64, age_65_above }']
  social_services jsonb [note: '{ registered_voters, philhealth_beneficiaries, fourps_beneficiaries }']
  economic_condition jsonb [note: '{ employments: [{type, count}], income_brackets: [{bracket, households}] }']
  agriculture jsonb [note: '{ farmers_count, farmer_associations, farm_area_hectares, top_crops[] }']
  water_sanitation jsonb [note: '{ water_systems_count, water_sources[], households_without_toilet, toilet_facility_types[], waste_segregation_practice }']
  livestock_poultry jsonb [note: '{ pigs, cows, carabaos, horses, goats, chickens, ducks }']
  food_security jsonb [note: '{ households_with_backyard_garden, common_garden_commodities[] }']
  housing jsonb [note: '{ quality_types: [{type, count}], ownership_types: [{type, count}] }']
  domestic_animals jsonb [note: '{ dogs, cats, dogs_vaccinated, cats_vaccinated }']
  community_empowerment jsonb [note: '{ sectoral_organizations, info_dissemination_methods[], transportation_methods[] }']
  utilities jsonb [note: '{ households_with_electricity, alternative_electricity_sources[] }']
  
  indexes {
    sitio_id [name: 'idx_sitio_data_sitio']
    year [name: 'idx_sitio_data_year']
    is_current [name: 'idx_sitio_data_current']
    (sitio_id, year) [unique, name: 'idx_sitio_data_unique']
  }
  
  Note: 'Sitio profiling data with year-over-year tracking. is_current=true indicates the active data for the sitio.'
}

Table projects {
  id integer [pk, increment]
  title varchar(500) [not null]
  description text
  category_key category_key [not null, note: 'FK to categories.key']
  project_type_id integer [ref: > project_types.id]
  status project_status [not null, default: 'planning']
  start_date date [not null]
  contract_duration varchar(50) [note: 'e.g., "180 CD" for calendar days']
  total_budget decimal(15,2) [not null, default: 0]
  contract_cost decimal(15,2) [not null, default: 0]
  beneficiaries integer [not null, default: 0]
  project_year integer [not null]
  
  // Status tracking
  issues text [note: 'Issues encountered']
  recommendations text [note: 'Recommended actions']
  catch_up_plan text
  
  implementing_agency varchar(100)
  
  created_at timestamp [not null, default: `now()`]
  updated_at timestamp
  
  indexes {
    status [name: 'idx_projects_status']
    category_key [name: 'idx_projects_category']
    project_year [name: 'idx_projects_year']
    start_date [name: 'idx_projects_start_date']
  }
  
  Note: 'Main project entity - related data normalized into separate tables'
}

Table users {
  id integer [pk, increment]
  name varchar(255) [not null]
  email varchar(255) [unique, not null]
  password_hash varchar(255) [not null]
  role user_role [not null, default: 'viewer']
  department varchar(100)
  is_active boolean [not null, default: true]
  
  // JSONB for flexible permissions (kept as JSONB for flexibility)
  permissions jsonb [not null, note: '{ sitios: {read, write, delete}, projects: {...}, users: {...}, audit_logs: {...} }']
  
  last_login timestamp
  created_at timestamp [not null, default: `now()`]
  updated_at timestamp
  
  indexes {
    email [unique, name: 'idx_users_email']
    role [name: 'idx_users_role']
    is_active [name: 'idx_users_active']
  }
  
  Note: 'System users with role-based access control and granular permissions'
}

// ============================================
// REFERENCE DATA
// ============================================

Table categories {
  id integer [pk, increment]
  key category_key [unique, not null]
  name varchar(100) [not null]
  description text
  icon varchar(50) [note: 'Icon identifier for UI']
  
  Note: 'Project category reference table'
}

Table project_types {
  id integer [pk, increment]
  category_key category_key [not null, ref: > categories.key]
  name varchar(255) [not null]
  description text
  
  indexes {
    category_key [name: 'idx_project_types_category']
  }
  
  Note: 'Specific project types within each category'
}

// ============================================
// PROJECT FINANCIAL TRACKING (Normalized 1:1)
// ============================================

Table project_employment {
  id integer [pk, increment]
  project_id integer [not null, ref: > projects.id, unique]
  male integer [not null, default: 0]
  female integer [not null, default: 0]
  
  created_at timestamp [not null, default: `now()`]
  updated_at timestamp
  
  indexes {
    project_id [name: 'idx_employment_project']
  }
  
  Note: 'Employment generated per project (1:1 relationship)'
}

// ============================================
// PROJECT TRACKING (Many-to-One)
// ============================================

Table project_sitios {
  project_id integer [not null, ref: > projects.id]
  sitio_id integer [not null, ref: > sitios.id]
  beneficiaries_target integer [default: 0]
  priority_level priority_level [default: 'medium']
  focal_person varchar(255)
  focal_contact varchar(100)
  
  indexes {
    (project_id, sitio_id) [pk]
    sitio_id [name: 'idx_project_sitios_sitio']
  }
  
  Note: 'Junction table linking projects to sitios (many-to-many)'
}

Table monthly_targets {
  id integer [pk, increment]
  project_id integer [not null, ref: > projects.id]
  month_year varchar(7) [not null, note: 'Format: YYYY-MM']
  planned_physical_progress decimal(5,2) [not null, default: 0, note: 'Planned cumulative physical progress %']
  planned_budget decimal(15,2) [not null, default: 0, note: 'Planned budget release for the month']
  
  created_at timestamp [not null, default: `now()`]
  updated_at timestamp
  
  indexes {
    project_id [name: 'idx_monthly_targets_project']
    (project_id, month_year) [unique, name: 'idx_monthly_targets_unique']
  }
  
  Note: 'Monthly planned targets for physical progress and budget (planning phase)'
}

Table monthly_progress {
  id integer [pk, increment]
  project_id integer [not null, ref: > projects.id]
  month_year varchar(7) [not null, note: 'Format: YYYY-MM']
  physical_progress_percentage decimal(5,2) [not null, default: 0, note: 'Actual physical progress %']
  budget_utilized decimal(15,2) [not null, default: 0, note: 'Actual budget utilized this month']
  beneficiaries_reached integer [default: 0]
  issues_encountered text
  status progress_status [not null, default: 'on_track']
  
  created_at timestamp [not null, default: `now()`]
  updated_at timestamp
  
  indexes {
    project_id [name: 'idx_monthly_progress_project']
    month_year [name: 'idx_monthly_progress_month']
    (project_id, month_year) [unique, name: 'idx_monthly_progress_unique']
  }
  
  Note: 'Actual monthly progress tracking with physical progress and budget utilized'
}

Table photo_documentation {
  id varchar(21) [pk, note: 'nanoid']
  monthly_progress_id integer [not null, ref: > monthly_progress.id]
  filename varchar(255) [not null]
  caption text
  file_size integer [not null, note: 'Size in bytes']
  mime_type varchar(50) [not null, note: 'e.g., image/jpeg']
  width integer [not null]
  height integer [not null]
  thumbnail_id varchar(21) [note: 'Reference to thumbnail']
  storage_type storage_type [not null, default: 'indexeddb']
  storage_ref varchar(500) [not null, note: 'IndexedDB key OR server URL']
  uploaded_at timestamp [not null, default: `now()`]
  
  indexes {
    monthly_progress_id [name: 'idx_photos_progress']
  }
  
  Note: 'Photo documentation attached to monthly progress'
}

Table budget_components {
  id integer [pk, increment]
  project_id integer [not null, ref: > projects.id]
  component_name varchar(255) [not null]
  amount decimal(15,2) [not null, default: 0]
  percentage decimal(5,2) [default: 0]
  
  indexes {
    project_id [name: 'idx_budget_components_project']
  }
  
  Note: 'Budget breakdown by component for each project'
}

Table funding_sources {
  id integer [pk, increment]
  project_id integer [not null, ref: > projects.id]
  source_name varchar(255) [not null]
  source_type funding_source_type [not null]
  amount decimal(15,2) [not null, default: 0]
  percentage decimal(5,2) [default: 0]
  
  indexes {
    project_id [name: 'idx_funding_sources_project']
    source_type [name: 'idx_funding_sources_type']
  }
  
  Note: 'Funding sources contributing to each project'
}

Table sitio_coordinators {
  id integer [pk, increment]
  project_id integer [not null, ref: > projects.id]
  sitio_id integer [not null, ref: > sitios.id]
  barangay_captain varchar(255)
  sitio_leader varchar(255)
  
  indexes {
    (project_id, sitio_id) [unique, name: 'idx_sitio_coordinators_unique']
  }
  
  Note: 'Coordinator assignments for each project-sitio combination'
}

Table coordinator_contacts {
  id integer [pk, increment]
  sitio_coordinator_id integer [not null, ref: > sitio_coordinators.id]
  contact_number varchar(20) [not null]
  is_primary boolean [default: false]
  
  indexes {
    sitio_coordinator_id [name: 'idx_coordinator_contacts_coordinator']
  }
  
  Note: 'Contact numbers for sitio coordinators'
}

// ============================================
// SYSTEM / AUDIT
// ============================================

Table audit_logs {
  id varchar(21) [pk, note: 'nanoid']
  user_id integer [ref: > users.id]
  user_name varchar(255) [not null, note: 'Denormalized for historical accuracy']
  action audit_action [not null]
  resource_type audit_resource_type [not null]
  resource_id varchar(50) [note: 'ID of affected resource']
  resource_name varchar(255) [note: 'Name/title of affected resource']
  details text [note: 'Additional context or changes summary']
  ip_address varchar(45)
  timestamp timestamp [not null, default: `now()`]
  
  indexes {
    timestamp [name: 'idx_audit_logs_timestamp']
    user_id [name: 'idx_audit_logs_user']
    resource_type [name: 'idx_audit_logs_resource_type']
    action [name: 'idx_audit_logs_action']
  }
  
  Note: 'Comprehensive audit trail for all system actions'
}

// ============================================
// TABLE GROUPS (for diagram organization)
// ============================================

TableGroup location_hierarchy [color: #f39c12] {
  provinces
  municipalities
  barangays
}

TableGroup core_entities [color: #3498db] {
  sitios
  sitio_data
  projects
  users
}

TableGroup reference_data [color: #9b59b6] {
  categories
  project_types
}

TableGroup project_financials [color: #1abc9c] {
  project_employment
  budget_components
  funding_sources
}

TableGroup project_tracking [color: #2ecc71] {
  project_sitios
  monthly_targets
  monthly_progress
  photo_documentation
  sitio_coordinators
  coordinator_contacts
}

TableGroup system [color: #e74c3c] {
  audit_logs
}
